# Google Login Setup Guide for Supabase

This guide will help you set up Google OAuth authentication in your Supabase project.

## Step 1: Create Google OAuth Credentials

### 1.1 Go to Google Cloud Console

1. Visit [Google Cloud Console](https://console.cloud.google.com/)
2. Sign in with your Google account
3. Create a new project or select an existing one

### 1.2 Enable Google+ API

1. In the Google Cloud Console, go to **APIs & Services** → **Library**
2. Search for "Google+ API" or "Google Identity Services API"
3. Click on it and click **Enable**

### 1.3 Create OAuth 2.0 Credentials

1. Go to **APIs & Services** → **Credentials**
2. Click **Create Credentials** → **OAuth client ID**
3. If prompted, configure the OAuth consent screen first:
   - Choose **External** (unless you have a Google Workspace)
   - Fill in the required information:
     - App name: Your app name (e.g., "SevApp")
     - User support email: Your email
     - Developer contact information: Your email
   - Click **Save and Continue**
   - Add scopes (optional): Click **Add or Remove Scopes**
     - Select: `email`, `profile`, `openid`
   - Click **Save and Continue**
   - Add test users (if in testing mode) or skip
   - Click **Back to Dashboard**

4. Now create the OAuth client ID:
   - Application type: **Web application**
   - Name: "Supabase Web Client" (or any name)
   - **Authorized JavaScript origins**:
     ```
     https://your-project-ref.supabase.co
     ```
     Replace `your-project-ref` with your Supabase project reference (found in your Supabase project URL)
   - **Authorized redirect URIs**:
     ```
     https://your-project-ref.supabase.co/auth/v1/callback
     ```
     Again, replace with your actual Supabase project reference
   - Click **Create**
   - **IMPORTANT**: Copy the **Client ID** and **Client Secret** - you'll need these in the next step

## Step 2: Configure Supabase

### 2.1 Add Google Provider in Supabase

1. Go to your [Supabase Dashboard](https://app.supabase.com)
2. Select your project
3. Go to **Authentication** → **Providers**
4. Find **Google** in the list and click on it
5. Toggle **Enable Google provider** to ON
6. Enter your credentials from Google Cloud Console:
   - **Client ID (for OAuth)**: 
     ```
     Example: 123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com
     ```
     Paste the Client ID you copied from Google Cloud Console
   
   - **Client Secret (for OAuth)**: 
     ```
     Example: GOCSPX-abcdefghijklmnopqrstuvwxyz123456
     ```
     Paste the Client Secret you copied from Google Cloud Console
7. Click **Save**

**Where to find these values:**
- Go back to Google Cloud Console → **APIs & Services** → **Credentials**
- Click on the OAuth 2.0 Client ID you just created
- Copy the **Client ID** (looks like: `123456789-xxx.apps.googleusercontent.com`)
- Copy the **Client secret** (looks like: `GOCSPX-xxx`)

### 2.2 Configure Redirect URLs in Supabase

**Step-by-step with example values:**

1. In Supabase dashboard, go to **Authentication** → **URL Configuration**

2. Find the **Redirect URLs** section (usually at the bottom of the page)

3. **Add your app's redirect URL:**

   **For Development (Expo Go on simulator/emulator):**
   ```
   exp://localhost:8081/--/
   ```
   - This is the default URL that `expo-auth-session` generates
   - Works when testing on iOS Simulator or Android Emulator
   - Copy and paste this EXACT value into Supabase

   **For Physical Device Testing:**
   - First, find your computer's local IP address:
     - **Windows**: Open Command Prompt, run `ipconfig`, look for "IPv4 Address" (e.g., `192.168.1.100`)
     - **Mac/Linux**: Open Terminal, run `ifconfig` or `ip addr`, look for your local network IP
   - Then use:
     ```
     exp://192.168.3.13:8081/--/
     ```
     (Replace `192.168.3.13` with YOUR actual IP address)

4. **Example - Complete Setup:**

   Let's say:
   - Your Supabase project URL is: `https://abcdefghijklmnop.supabase.co`
   - Your computer's IP is: `192.168.1.100`
   
   **In Supabase → Authentication → URL Configuration → Redirect URLs:**
   ```
   exp://localhost:8081/--/
   exp://192.168.1.100:8081/--/
   ```
   (Add both if you test on both simulator and physical device)

5. Click **Save**

**Important Notes:**
- ✅ The format `exp://localhost:8081/--/` is automatically generated by `expo-auth-session`
- ✅ The `exp://` scheme comes from your `app.json` configuration
- ✅ The `--/` path is required for Expo deep linking
- ❌ Do NOT use `https://` URLs here - those go in Google Cloud Console instead

### 2.3 Configure Redirect URI in Google Cloud Console

**CRITICAL**: This is DIFFERENT from Supabase redirect URLs!

**In Google Cloud Console:**

1. Go to **APIs & Services** → **Credentials**
2. Click on your OAuth 2.0 Client ID (the one you created earlier)
3. In **Authorized redirect URIs**, you need your **Supabase callback URL**, NOT your app URL

**Example - If your Supabase project URL is `https://abcdefghijklmnop.supabase.co`:**

**In Google Cloud Console → Authorized redirect URIs, add:**
```
https://abcdefghijklmnop.supabase.co/auth/v1/callback
```

**Complete Example Setup:**

Let's say your Supabase project URL is: `https://xyzabc123456789.supabase.co`

**Google Cloud Console → OAuth 2.0 Client → Authorized redirect URIs:**
```
https://xyzabc123456789.supabase.co/auth/v1/callback
```

**Supabase → Authentication → URL Configuration → Redirect URLs:**
```
exp://localhost:8081/--/
```

**Why Two Different URLs?**

The OAuth flow works like this:
1. **Your App** → Opens Supabase OAuth URL
2. **Supabase** → Redirects to Google OAuth
3. **Google** → After login, redirects back to Supabase callback: `https://your-project.supabase.co/auth/v1/callback`
4. **Supabase** → Processes the OAuth response, then redirects to your app: `exp://localhost:8081/--/`

So:
- **Google Cloud Console** needs: Supabase callback URL (where Google sends the user after login)
- **Supabase** needs: Your app URL (where Supabase sends the user after processing)

## Step 3: Update Your App Code

The auth service has been updated to support Google login. You can now use it in your login screen.

### Usage Example:

```typescript
import { authService } from '../services/authService';

// Sign in with Google
const { user, session, error } = await authService.signInWithGoogle();
```

## Step 4: Test Google Login

1. Run your app: `npm start`
2. Navigate to the login screen
3. Click the "Sign in with Google" button
4. You should be redirected to Google's sign-in page
5. After signing in, you'll be redirected back to your app

## Troubleshooting

### Issue: "redirect_uri_mismatch" Error

**Solution**: 
- Make sure the redirect URI in Google Cloud Console exactly matches:
  ```
  https://your-project-ref.supabase.co/auth/v1/callback
  ```
- Check your Supabase project reference in the URL Configuration

### Issue: "Invalid client" Error

**Solution**:
- Verify the Client ID and Client Secret are correct in Supabase
- Make sure you copied them from the correct OAuth client (Web application type)

### Issue: App doesn't redirect back after Google login

**Solution**:
- Check that your redirect URLs are configured in Supabase
- For Expo, make sure you're using the correct scheme
- Test with `exp://localhost:8081/--/` for development

### Issue: "OAuth consent screen" Error

**Solution**:
- Make sure you've configured the OAuth consent screen in Google Cloud Console
- If your app is in testing mode, add your email as a test user
- Publish your app if you want to allow all users (requires verification for sensitive scopes)

## Additional Configuration

### For Production

1. **Update OAuth Consent Screen**:
   - Go to Google Cloud Console → **OAuth consent screen**
   - Add your app logo
   - Add privacy policy and terms of service URLs
   - Publish your app (if ready)

2. **Update Redirect URLs**:
   - Add your production app's deep link URL
   - Update in both Google Cloud Console and Supabase

3. **Security**:
   - Never commit your Client Secret to version control
   - Use environment variables for sensitive data
   - Regularly rotate your OAuth credentials

## Notes

- Google OAuth works seamlessly with Supabase Auth
- User data (email, name, profile picture) is automatically synced
- You can combine Google login with email/password authentication
- Users can link multiple providers to the same account

## Resources

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Expo AuthSession Documentation](https://docs.expo.dev/versions/latest/sdk/auth-session/)

